<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Add a 3D model</title>
		<meta
			name="viewport"
			content="initial-scale=1,maximum-scale=1,user-scalable=no"
		/>
		<link
			href="https://api.mapbox.com/mapbox-gl-js/v1.13.1/mapbox-gl.css"
			rel="stylesheet"
		/>
		<script src="https://api.mapbox.com/mapbox-gl-js/v1.13.1/mapbox-gl.js"></script>
		<style>
			body {
				margin: 0;
				padding: 0;
			}
			#map {
				position: absolute;
				top: 0;
				bottom: 0;
				width: 100%;
			}
		</style>
	</head>
	<body>
		<script src="https://unpkg.com/three@0.117.1/build/three.min.js"></script>
		<script src="https://unpkg.com/three@0.117.1/examples/js/loaders/GLTFLoader.js"></script>
		<script src="https://unpkg.com/three@0.117.1/examples/js/postprocessing/EffectComposer"></script>
		<script src="https://unpkg.com/three@0.117.1/examples/js/postprocessing/ShaderPass"></script>
		<script src="https://unpkg.com/three@0.117.1/examples/js/postprocessing/RenderPass"></script>
		<script src="./ColorShader.js"></script>
		<script src="./ColorPass.js"></script>
		<script src="./threebox.js"></script>

		<div id="map"></div>
		<script type="module">
			import { GUI } from 'https://unpkg.com/three@0.140.0/examples/jsm/libs/lil-gui.module.min.js'
			mapboxgl.accessToken =
				'pk.eyJ1IjoiY2F0bnVrbyIsImEiOiJja2MwMDUxc2Iwa2RjMnFxcWk4c2cwcjQ5In0.VlIEyCroRFIp67cwUWLz1Q'
			const map = new mapboxgl.Map({
				container: 'map',
				// Choose from Mapbox's core styles, or make your own style with Mapbox Studio
				style: 'mapbox://styles/mapbox/outdoors-v10',
				zoom: 18,
				center: [148.9819, -35.3981],
				pitch: 60,
				antialias: true, // create the gl context with MSAA antialiasing, so custom layers are antialiased
			})

			// parameters to ensure the model is georeferenced correctly on the map
			const modelOrigin = [148.9819, -35.39847]
			const modelAltitude = 0
			const modelRotate = [Math.PI / 2, 0, 0]

			const modelAsMercatorCoordinate = mapboxgl.MercatorCoordinate.fromLngLat(
				modelOrigin,
				modelAltitude
			)

			// transformation parameters to position, rotate and scale the 3D model onto the map
			const modelTransform = {
				translateX: modelAsMercatorCoordinate.x,
				translateY: modelAsMercatorCoordinate.y,
				translateZ: modelAsMercatorCoordinate.z,
				rotateX: modelRotate[0],
				rotateY: modelRotate[1],
				rotateZ: modelRotate[2],
				/* Since the 3D model is in real world meters, a scale transform needs to be
				 * applied since the CustomLayerInterface expects units in MercatorCoordinates.
				 */
				scale: modelAsMercatorCoordinate.meterInMercatorCoordinateUnits(),
			}

			const THREE = window.THREE
			let composer, cube

			// configuration of the custom layer for a 3D model per the CustomLayerInterface
			const customLayer = {
				id: '3d-model',
				type: 'custom',
				renderingMode: '3d',
				onAdd: function (map, gl) {
					window.tb = new Threebox(map, gl, { defaultLights: true })

					var options = {
						obj: './34M_17.gltf',
						type: 'gltf',
						scale: 1,
						units: 'meters',
						rotation: { x: 90, y: 0, z: 0 }, //default rotation
					}

					tb.loadObj(options, function (model) {
						const soldier = model.setCoords(origin)
						tb.add(soldier)
					})
				},
				render: function (gl, matrix) {
					tb.update()
				},
			}

			map.on('style.load', () => {
				map.addLayer(customLayer, 'waterway-label')
			})
		</script>
	</body>
</html>
